# Nombre del flujo de trabajo que verás en la pestaña "Actions" de GitHub
name: Build 3DLab y Despliegue en Meta

# 1. DISPARADOR: Cuándo debe ejecutarse
on:
  push:
    branches:
      - main  # Se activa solo cuando subes cambios a la rama 'main'

# 2. TRABAJOS: Qué debe hacer
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # Usamos un servidor virtual Linux

    steps:
      # --- FASE DE PREPARACIÓN ---

      # 2.1. Clona tu repositorio (Forma correcta de LFS)
      - name: Checkout 3DLab Repository
        uses: actions/checkout@v4
        with:
          lfs: true 

      # --- ¡¡NUEVO PASO!! (Método Manual) ---
      # 2.2. Libera espacio en el disco del runner antes de construir
      - name: Free up disk space (Manual)
        run: |
          echo "Limpiando espacio en disco..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          echo "Espacio después de limpiar:"
          df -h

      # --- FASE DE BUILD (Compilación en Unity con Licencia PRO) ---
      
      # 2.3. Compila el proyecto con game-ci (Método Profesional)
      - name: Build 3DLab APK
        uses: game-ci/unity-builder@v4
        env:
          # Secretos de Licencia
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }} 
          
          # Secretos de Firmado (¡AHORA COMPLETOS!)
          ANDROID_KEYSTORE_PASS: ${{ secrets.ANDROID_KEYSTORE_PASS }}
          ANDROID_KEY_ALIAS_NAME: ${{ secrets.ANDROID_KEY_ALIAS_NAME }}
          ANDROID_KEY_ALIAS_PASS: ${{ secrets.ANDROID_KEY_ALIAS_PASS }}
          
        with:
          targetPlatform: Android 
          buildName: 3DLab-Build 
          buildsPath: builds
          # Le decimos a Unity dónde encontrar el Keystore que acabamos de crear
          # androidKeystoreName: user.keystore
          # Le decimos a Unity que la ruta del Keystore es la raíz del proyecto
          # androidKeystorePath: ${{ github.workspace }} 

      # --- FASE DE DEPLOY (Despliegue en Meta) ---

      # 2.4. Instala la herramienta de Meta (Oculus CLI)
      - name: Install Oculus CLI
        run: |
          curl -LO https://www.oculus.com/download_app/?id=1462426033810370
          mv 1462426033810370 ovr-platform-util.zip
          unzip ovr-platform-util.zip
          chmod +x ovr-platform-util

      # 2.5. Sube el APK al canal ALPHA
      - name: Upload APK to Meta App Lab (ALPHA)
        run: |
          ./ovr-platform-util upload-quest-build \
          --app_id ${{ secrets.META_APP_ID }} \
          --app_secret ${{ secrets.META_APP_SECRET }} \
          --apk builds/3DLab-Build.apk \
          --channel ALPHA \
          --notes "Build automático (v4) desde GitHub Actions"